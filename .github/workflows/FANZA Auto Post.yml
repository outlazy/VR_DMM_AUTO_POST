name: FANZA VR Auto Post

on:
  workflow_dispatch: {} # 手動実行OK
  schedule:
    - cron: "*/30 * * * *"  # 30分ごと（UTC）。JSTは+9時間

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # （任意）到達性チェック：WP_URL のDNS/接続を事前確認
      - name: Preflight: resolve & HEAD xmlrpc
        env:
          WP_URL: ${{ secrets.WP_URL }}
        run: |
          set -euxo pipefail
          python - <<'PY'
import os, socket, urllib.parse, requests
u = urllib.parse.urlparse(os.environ['WP_URL'].strip())
host = u.hostname
print("Host:", host)
print("DNS:", socket.gethostbyname(host))
r = requests.head(os.environ['WP_URL'].strip(), timeout=12, allow_redirects=True)
print("HEAD status:", r.status_code)
PY

      - name: Run VR auto post
        env:
          WP_URL: ${{ secrets.WP_URL }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_PASS: ${{ secrets.WP_PASS }}
          DMM_API_ID: ${{ secrets.DMM_API_ID }}
          DMM_AFFILIATE_ID: ${{ secrets.DMM_AFFILIATE_ID }}
          CATEGORY: ${{ secrets.CATEGORY }}
        run: python fanza_vr_auto_post.py
